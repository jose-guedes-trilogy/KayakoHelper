<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Kayako Helper</title>

    <style>
        /* Aesthetics aligned with Ephor Settings & Assets Inspector */
        body      { font-family: system-ui, sans-serif; margin: 0; width: 600px; }
        :root{
            --kh-input-border: hsl(213deg 15% 84%);
            --kh-input-shadow: inset 0 0 4px 0 hsla(0,0%,0%,0.0325), inset 0 0 2px 0 hsla(0,0%,0%,0.0805), inset 0 0 1px 0 hsla(0,0%,0%,0.089);
            --kh-input-bg: #fff;
        }

        /* Container feel */
        section   { display:none;padding:1rem; background:#fff; border:1px solid hsl(213deg 15% 88%); border-radius:8px; box-shadow:0 6px 18px rgba(17,24,39,.06); margin:10px; }
        section.active{ display:block; }

        /* Tabs (top-level + settings) */
        nav       { display:flex;border-bottom:1px solid #ddd; padding: 6px 10px 0; }
        .kh-bar-btn { border: none; background: none; cursor: pointer; padding: 6px 12px; border-radius: 4px; font-weight:600; }
        .kh-bar-btn:hover{ background:hsl(217 40% 98% / 1); color:#1a2b4f; border:1px solid #adc1e3; }
        .kh-bar-btn.active{ background:hsl(216 20% 98% / 1); color:#333; border:1px solid #cfd3d9; border-bottom-color: transparent; position: relative; top: 1px; }

        /* Top-level tabs behave like tabs, not buttons, on hover */
        nav .kh-bar-btn{ border:0; background:transparent; border-radius:0; }
        nav .kh-bar-btn:hover{ background:#f8f8f8; border:0; border-bottom:2px solid #adc1e3; }
        nav .kh-bar-btn.active{ background:#fff; border:0; border-bottom:2px solid dodgerblue; top:0; }

        /* Buttons */
        .kh-btn { padding:4px 12px; border:1px solid #ccc; border-radius:4px; background:#fff; cursor:pointer; font:inherit; display:inline-flex; align-items:center; gap:4px; box-shadow: 0 1px 1px rgba(0,0,0,.05), 0 2px 3px rgba(0,0,0,.04); }
        .kh-btn:hover { background:#f5f7ff; border-color:#99a; }
        .kh-btn:active { transform:translateY(1px); box-shadow: 0 1px 1px rgba(0,0,0,.03); }
        .kh-btn-primary { background:#2e73e9; color:#fff; border-color:#2e73e9; }
        .kh-btn-primary:hover { background:#255ecd; color:#fff; }

        /* Checkboxes (subtle 3D) */
        input[type="checkbox"]{
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width:14px; height:14px; vertical-align:middle;
            border:1px solid var(--kh-input-border);
            border-radius:3px; background:#fff;
            box-shadow: 0 1px 1px rgba(0,0,0,.05), 0 2px 3px rgba(0,0,0,.04);
            position: relative; cursor: pointer;
        }
        input[type="checkbox"]:hover{ background:#f9fbff; border-color:#adc1e3; }
        input[type="checkbox"]:active{ box-shadow: 0 1px 1px rgba(0,0,0,.03); }
        input[type="checkbox"]:focus-visible{ outline:none; box-shadow:0 0 0 2px rgba(46,115,233,.25); }
        input[type="checkbox"]:checked{ border-color: hsl(217.86deg 73.66% 70.67%); background: linear-gradient(180deg, #e9f1ff, #dfeaff); }
        input[type="checkbox"]:checked::after{
            content:""; position:absolute; left:3px; top:1px; width:6px; height:9px;
            border-right:2px solid #2e73e9; border-bottom:2px solid #2e73e9; transform: rotate(45deg);border-color: hsl(217.86deg 66% 54.71%);
        }

        /* Inputs */
        input[type="text"], input[type="search"], input[type="number"], input[type="color"], textarea {
            border:1px solid var(--kh-input-border);
            border-radius:4px; background:var(--kh-input-bg); box-shadow:var(--kh-input-shadow);
        }
        input[type="text"]:focus, input[type="search"]:focus, input[type="number"]:focus, textarea:focus {
            outline:none; border-color:#89b5ff !important; box-shadow:0 0 0 2px rgba(46,115,233,.15) !important;
        }

        .kh-popup-setting{ margin-bottom:.8rem; }
        label     { user-select:none; }

        ul{ list-style:none;padding-left:0; }
        li{ line-height:1.3; }

        /* Headings */
        h4{ text-align:center; font-size:1.15rem; margin:.8rem 0 .6rem; }

        #kh-ticket-info{ display:grid;grid-template-columns:max-content 1fr;gap:.5rem; }
        .kh-ticket-info-label{ font-weight:600; }

        /* sub-tab bar inside ticket list */
        #kh-ticket-list-tabs{ display:flex;border-bottom:1px solid #ddd;margin-bottom:.3rem; }
        #kh-ticket-list-tabs button{ flex:1;padding:.4rem 0;border:0;background:#f8f8f8;font-weight:600;cursor:pointer; }
        #kh-ticket-list-tabs button.active{ background:#fff;border-bottom:2px solid dodgerblue; }

        /* pagination */
        #kh-pagination button{ margin:0 .25rem;padding:.15rem .5rem;border:1px solid #ccc;background:#f8f8f8;cursor:pointer; }
        #kh-pagination button[disabled]{ opacity:.4;cursor:default; }

        /* inner settings tabs */
        #kh-settings-tabs{ display:flex;border-bottom:1px solid #ddd;margin:-.2rem 0 .6rem; gap:0; }
        #kh-settings-tabs button{ flex:1; border:0; background:#f8f8f8; font-weight:600; cursor:pointer; border-radius:0; }
        #kh-settings-tabs button.active{ background:#fff; border-bottom:2px solid dodgerblue; }
        #kh-settings-tabs button:hover{ background:#fff; }
        #kh-settings-panels .settings-subsection{ display:none; }
        #kh-settings-panels .settings-subsection.active{ display:block; }

        /* Notes textarea layout fix */
        #kh-popup-ticket-notes{ box-sizing:border-box; width:100%; display:block; max-width:100%; }

        /* Date range picker */
        #kh-date-range-picker{ position:absolute; background:#fff; border:1px solid #ddd; box-shadow:0 2px 10px rgba(0,0,0,.1); padding:.5rem; z-index:10; }
        .kh-date-header{ display:flex;align-items:center;justify-content:space-between;margin-bottom:.3rem; }
        .kh-date-grid{ display:grid;grid-template-columns:repeat(7,1fr);gap:.2rem; }
        .kh-date-cell{ text-align:center;padding:.25rem 0;cursor:pointer;border-radius:4px; }
        .kh-date-cell:hover{ background:#f0f7ff; }
        .kh-date-cell.kh-in-range{ background:#e6f0ff; }
        .kh-date-cell.kh-selected{ background:#cfe3ff; font-weight:600; }
        .kh-date-weekday{ font-size:.75rem;color:#666; text-align:center; }
        .kh-date-actions{ display:flex;gap:.4rem;justify-content:flex-end;margin-top:.4rem; }

        /* Date trigger look */
        #kh-date-range-trigger{ display:inline-flex; align-items:center; gap:.35rem; padding:.3rem .6rem; border:1px solid #cfd3d9; background:#f8fbff; border-radius:6px; }

        /* Ticket list item styling */
        #kh-ticket-list li.kh-ticket-item{ padding:.5rem .5rem; border-bottom:1px solid #eee; }
        .kh-item-row{ display:flex; align-items:center; justify-content:space-between; gap:.5rem; }
        .kh-item-main{ display:flex; align-items:baseline; gap:.35rem; }
        .kh-item-subject{ color:#444; }
        .kh-delete-btn{ border:1px solid #ccc; background:#fff; color:#555; border-radius:4px; padding:.1rem .4rem; cursor:pointer; }
        .kh-delete-btn:hover{ background:#ffecec; border-color:#e7a1a1; color:#a11; }
        .kh-item-meta{ display:flex; flex-wrap:wrap; gap:.4rem; margin-top:.2rem; color:#555; }
        .kh-badge{ display:inline-block; padding:.05rem .35rem; border-radius:999px; background:#eef3ff; border:1px solid #c7d6ff; font-size:.75rem; }
        .kh-date{ font-size:.8rem; color:#666; }
    </style>
</head>
<body>

<!-- top-level tabs -->
<nav>
    <button class="tab kh-bar-btn active" data-tab="main">Main</button>
    <button class="tab kh-bar-btn"        data-tab="settings">Settings</button>
</nav>

<!-- Global: Copy open Kayako ticket URLs/IDs (outside of tabs) -->
<div style="padding: 0 10px; text-align: center">
    <button id="kh-copy-open-tabs-btn" class="kh-btn"
            title="Left click: copy URLs. Right-click: copy IDs. Ctrl+Click: CSV"
            style="margin:.6rem 0 .4rem .5rem;">
        Copy all ticket URLs in this tab
    </button>
    
    <!-- Date range display mirrors list filter; remains in Main tab UI -->
</div>

<!-- MAIN -->
<section id="tab-main" class="active">
    <h4>This ticket</h4>
    <div id="kh-ticket-info">
        <div class="kh-ticket-info-label">ID:</div>              <div><span id="kh-popup-ticket-info-id">-</span></div>
        <div class="kh-ticket-info-label">Subject:</div>         <div><span id="kh-popup-ticket-info-subject">-</span></div>
        <div class="kh-ticket-info-label">Requester:</div>       <div><span id="kh-popup-ticket-info-requester-name">-</span></div>
        <div class="kh-ticket-info-label">Requester Email:</div> <div><span id="kh-popup-ticket-info-requester-email">-</span></div>
        <div class="kh-ticket-info-label">Your Tracked Replies:</div>    <div><span id="kh-popup-ticket-info-reply-count">0</span></div>
        <div class="kh-ticket-info-label">Product:</div>         <div><span id="kh-popup-ticket-info-product">-</span></div>
        <div class="kh-ticket-info-label">Last Access:</div>     <div><span id="kh-popup-ticket-info-last">-</span></div>
    </div>

    <!-- Bookmark toggle -->
    <div style="margin:.5rem 0 .3rem;">
        <button id="kh-bookmark-toggle" class="kh-btn" title="Bookmark this ticket" disabled>☆ Bookmark this ticket</button>
    </div>

    <!-- Notes -->
    <label for="kh-popup-ticket-notes" style="display:block;margin:.8rem 0 .3rem;font-weight:600">Notes</label>
    <textarea id="kh-popup-ticket-notes" rows="4" style="width:100%;padding:.4rem;font-family:inherit" disabled></textarea>


    <h4>Tracked Tickets</h4>
    <!-- sub-tabs -->
    <div id="kh-ticket-list-tabs">
        <button class="list-tab active" data-list="saved">Replied to</button>
        <button class="list-tab"        data-list="visited">Visited</button>
        <button class="list-tab"        data-list="bookmarked">Bookmark</button>
    </div>

    <!-- Date range filter (single calendar with two selections) -->
    <div id="kh-date-filter" style="position:relative;margin:.25rem 0 .4rem 0;display:flex;gap:.5rem;align-items:center;flex-wrap:wrap">
        <button id="kh-date-range-trigger" style="padding:.2rem .5rem;border:1px solid #ccc;background:#f8f8f8;cursor:pointer">📅 Date range</button>
        <span id="kh-date-range-display" style="font-size:.85rem;color:#555">All dates</span>

        <div id="kh-date-range-picker" style="display:none;top:2.0rem;left:0">
            <div class="kh-date-header">
                <button id="kh-date-prev" title="Prev" style="border:1px solid #ccc;background:#f8f8f8;cursor:pointer">◀</button>
                <div id="kh-date-month" style="font-weight:600"></div>
                <button id="kh-date-next" title="Next" style="border:1px solid #ccc;background:#f8f8f8;cursor:pointer">▶</button>
            </div>
            <div class="kh-date-grid" id="kh-date-grid">
                <!-- weekdays header -->
            </div>
            <div class="kh-date-actions">
                <button class="kh-date-clear" id="kh-date-clear" style="border:1px solid #ccc;background:#f8f8f8;cursor:pointer">Clear</button>
                <button class="kh-date-apply" id="kh-date-apply" style="border:1px solid #ccc;background:dodgerblue;color:#fff;cursor:pointer">Apply</button>
            </div>
        </div>
    </div>

    <input type="search" id="kh-search-tickets"
           placeholder="Filter by ID, subject, requester, notes…"
           style="width:100%;padding:.3rem;margin-bottom:.5rem" />

    <ul id="kh-ticket-list" style="max-height:12rem;overflow:auto;"></ul>
    <div id="kh-pagination" style="text-align:center;margin-top:.5rem;"></div>
</section>

<!-- SETTINGS -->
<section id="tab-settings">
    <!-- inner settings tabs -->
    <div id="kh-settings-tabs">
        <button class="setting-tab kh-bar-btn active" data-settings="general">General</button>
        <button class="setting-tab kh-bar-btn"        data-settings="ui">UI</button>
    </div>

    <div id="kh-settings-panels">
        <!-- GENERAL (existing contents, except style toggle moved) -->
        <div id="kh-sub-general" class="settings-subsection active">
            <div class="kh-popup-setting">
                <label><input type="checkbox" id="kh-training-mode-checkbox" /> Training mode <small>(warn before public replies)</small></label>
            </div>
            <div class="kh-popup-setting">
                <label><input type="checkbox" id="kh-hide-messenger-checkbox" /> Hide Kayako Messenger</label>
            </div>
            <div class="kh-popup-setting">
                <label for="kh-send-in-chunks-wpm-limit">Max words per minute&nbsp;</label>

                <input type="number" id="kh-send-in-chunks-wpm-limit"
                       value="200" min="50" max="800" step="10"
                       style="width:6rem;padding:.2rem" />
            </div>

            <!-- Send to QC settings -->
            <div class="kh-popup-setting">
                <label><input type="checkbox" id="kh-setting-qc-btn-enabled" checked /> Show “Send to QC” button</label>
            </div>
            <div class="kh-popup-setting">
                <label><input type="checkbox" id="kh-setting-qc-template-only" /> “Send to QC”: insert template only (don’t paste clipboard)</label>
            </div>

            <!-- Ephor API token -->
            <div class="kh-popup-setting">
                <label for="kh-ephor-api-token">Ephor API token</label><br>
                <input type="password"
                       id="kh-ephor-api-token"
                       placeholder="Paste token here"
                       style="width:100%;padding:.3rem" />
                <small style="color:#666">Stored only in Chrome local storage</small>
            </div>
        </div>

        <!-- UI (new tab) -->
        <div id="kh-sub-ui" class="settings-subsection">
            <div class="kh-popup-setting">
                <label><input type="checkbox" id="kh-toggle-styles-checkbox" /> Enable OmniHelper styles</label>
            </div>

            <div class="kh-popup-setting">
                <label><input type="checkbox" id="kh-ui-dark-compat-checkbox" /> Dark mode compatibility for OmniHelper buttons</label>
            </div>

            <div class="kh-popup-setting">
                <label for="kh-ui-dark-text-color">Dark mode text color</label><br>
                <input type="color" id="kh-ui-dark-text-color" value="#EAEAEA" />
            </div>

            <div class="kh-popup-setting">
                <label for="kh-ui-dark-bg-color">Dark mode background color</label><br>
                <input type="color" id="kh-ui-dark-bg-color" value="#1E1E1E" />
            </div>


            <!-- Results page auto-update -->
            <div class="kh-popup-setting">
                <label><input type="checkbox" id="kh-search-results-autoupdate" checked /> Auto-update results while typing (results page)</label>
            </div>

            <!-- Search in behavior -->
            <div class="kh-popup-setting">
                <label><input type="checkbox" id="kh-searchin-remember" /> Remember 'Search in' choices</label>
            </div>

            <div class="kh-popup-setting" id="kh-searchin-defaults-wrap">
                <div style="margin-bottom:.25rem">Default 'Search in' when not remembering:</div>
                <div style="display:flex;gap:8px;flex-wrap:wrap">
                    <label><input type="checkbox" id="kh-searchin-def-conv" /> Conversations</label>
                    <label><input type="checkbox" id="kh-searchin-def-users" /> Users</label>
                    <label><input type="checkbox" id="kh-searchin-def-orgs" /> Organizations</label>
                    <label><input type="checkbox" id="kh-searchin-def-articles" /> Articles</label>
                </div>
            </div>
        </div>
    </div>
</section>

<script type="module" src="popup.js"></script>
</body>
</html>
